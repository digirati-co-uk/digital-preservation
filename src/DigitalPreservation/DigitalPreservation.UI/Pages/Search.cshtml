@page "{*pathUnderRoot}"
@using DigitalPreservation.Common.Model.Search
@model DigitalPreservation.UI.Pages.SearchModel


@{
    ViewData["section"] = "search";

    var results = Model.SearchModelData;
    var text = results?.text ?? string.Empty;
    var pages = results?.FedoraSearch?.Total / results?.FedoraSearch?.PageSize;

    if (pages is not null)
    {
        if ((results?.FedoraSearch?.Total % results?.FedoraSearch?.PageSize) > 0)
        {
            pages++;
        }
    }

    if (Model.ModelState.ErrorCount > 0)
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">There were some errors with your submission</h4>
            <ul>
                @foreach (var error in Model.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">

        <div class="btn-toolbar mb-2 mb-md-0">
            <form method="post" class="form-search">
                <input id="text" name="text" class="input btn-sm btn-outline-primary me-2 form-search-input" value="@text" type="@text" placeholder="search text" aria-label="Search">

                <button id="search_btn" type="submit" class="btn btn-sm btn-outline-primary me-2"
                        asp-page-handler="Search"
                        data-bs-theme-value="dark" aria-pressed="false">
                    Search
                </button>
            </form>
        </div>
    </div>


    //Show first tab with results
    var fedHasRecs = results?.FedoraSearch?.Results?.Any() ?? false;
    var depHasRecs = !fedHasRecs && (results?.DepositSearch?.Deposits?.Any() ?? false);
    var identHasRec = !depHasRecs && results?.Identifier is not null;

    var fedoraTabShow = fedHasRecs ? "active show" : "fade";
    var depositTabShow = depHasRecs ? "active show" : "fade";
    var identTabShow = identHasRec ? "active show" : "fade";

    var fedActive = fedHasRecs ? "active" : "";
    var depActive = depHasRecs ? "active" : "";
    var identActive = identHasRec ? "active" : "";



    <div class="container  my-5 container-search">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @fedActive" id="fedora-tab-btn" data-bs-toggle="tab" data-bs-target="#fedora-tab"
                        type="button" role="tab" aria-controls="fedora-tab-btn"
                        aria-selected="@fedHasRecs">
                    Fedora <sub>@results?.FedoraSearch?.Total</sub>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @depActive" id="deposit-tab-btn" data-bs-toggle="tab" data-bs-target="#deposit-tab"
                        type="button" role="tab" aria-controls="deposit-tab-btn" aria-selected="@depHasRecs">
                    Deposit <sub>@results?.DepositSearch?.Total</sub>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @identActive" id="contact-tab-btn" data-bs-toggle="tab" data-bs-target="#identifier-tab"
                        type="button" role="tab" aria-controls="identifier-tab-btn" aria-selected="@identHasRec">
                    Identifier <sub>@(identHasRec ? 1 : 0)</sub>
                </button>
            </li>
        </ul>




        @if (results?.FedoraSearch is null)
            return;





        @*************  Fedora Search Results  *************@
        <div class="tab-content mt-3" id="myTabContent">
            <div class="tab-pane @fedoraTabShow" id="fedora-tab" role="tabpanel" aria-labelledby="fedora-tab">
                <h3>Fedora</h3>

                <div id="search_results">
                    <p>@results.FedoraSearch?.Total records found</p>
                    <table class="table table-hover table-striped table-sm plain-link-table deposit-table" aria-label="table-deposit-files">
                        <thead>
                        <tr>
                            <th scope="col">View</th>
                            <th scope="col">FedoraId</th>
                            <th scope="col">Created</th>
                            <th scope="col">LastModified</th>
                            <th scope="col">bytes</th>
                            <th scope="col">Mime</th>
                        </tr>
                        </thead>
                        <tbody>

                        @{
                            foreach (var result in results?.FedoraSearch?.Results)
                            {
                                var fullPath = result.FedoraId.Replace("info:fedora", "/browse");

                                <tr>
                                    <td>
                                        <a href="@fullPath" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                                                <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                                            </svg>
                                        </a>
                                    </td>
                                    <td>
                                    @result.FedoraId
                                    <td>
                                        @result.Created
                                    </td>
                                    <td>
                                        @result.LastModified
                                    </td>
                                    <td>
                                        @result.ContentSize
                                    </td>
                                    <td>
                                        @result.Mime_Type
                                    </td>
                                </tr>
                            }
                        }
                        <tbody>
                    </table>
                </div>

                <div page></div>

               @if (pages > 1)
                {
                <form method="post">
                    <input id="text" name="text" type="hidden" value="@text"/>

                    @for (var i = 0; i < pages; i++)
                    {
                        <button name="page" type="submit" class="btn btn-sm "
                                asp-page-handler="PageChange"
                                data-bs-theme-value="dark"
                                value="@i"
                                disabled="@(results?.FedoraSearch?.Page == i ? " disabled" : null)"
                                aria-pressed="false">
                            @(i + 1)
                        </button>

                        if (i > 18)
                        {
                            <span>...</span>
                            break;
                        }
                    }
                </form>
                }
            </div>

            

            @*************  Deposit Search Results  *************@
            <div class="tab-pane @depositTabShow " id="deposit-tab" role="tabpanel" aria-labelledby="deposit-tab">
               
                <h3>Deposits</h3>

                <div id="search_results">
                    <p>@results.DepositSearch?.Total records found</p>
                    <table class="table table-hover table-striped table-sm plain-link-table deposit-table" aria-label="table-deposit-files">
                        <thead>
                        <tr>
                            <th scope="col">View</th>
                            <th scope="col">Id</th>
                            <th scope="col">Status</th>
                            <th scope="col">Archival Group</th>
                            <th scope="col">Submission Text</th>
                            <th scope="col">Files</th>
                            <th scope="col">Created</th>
                            <th scope="col">By</th>
                        </tr>
                        </thead>
                        <tbody>

                            @{
                                foreach (var result in results.DepositSearch?.Deposits ?? [])
                                {
                                    var labelId = result.Id?.ToString().Split("/").Last();
                                    var localPath = $"/deposits/{labelId}";

                                    <tr>
                                        <td>
                                            <a href="@localPath" target="_blank">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                                                    <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                                                </svg>
                                            </a>
                                        </td>
                                        <td>
                                            @labelId
                                        </td>
                                        <td>
                                            @result.Status
                                        </td>
                                        <td>
                                            @result.ArchivalGroupName
                                        <td>
                                            @result.SubmissionText
                                        </td>
                                        <td>
                                            @result.Files
                                        </td>
                                        <td>
                                            @result.Created
                                        </td>
                                        <td>
                                            @result.CreatedBy?.ToString().Split("/").Last()
                                        </td>
                                    </tr>
                                }
                            }
                        <tbody>
                    </table>
                </div>


                @*************  Deposit Search Results END *************@
            </div>
            
            @*************  identifier Search Results *************@
            <div class="tab-pane @identTabShow" id="identifier-tab" role="tabpanel" aria-labelledby="identifier-tab">

                <h2 class="mb-3">Identifier</h2>
                @if (results?.Identifier is not null)
                {
                    <div>
                        <table class="table table-hover table-striped table-sm plain-link-table deposit-table" aria-label="table-deposit-files">
                            <thead>
                            <tr>
                                <th scope="col">Label</th>
                                <th scope="col">Value</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Id</td>
                                <td>@results.Identifier.Id</td>
                            </tr>
                            <tr>
                                <td>Title</td>
                                <td>@results.Identifier.Title</td>
                            </tr>
                            <tr>
                                <td>Cat Irn</td> 
                                <td>@results.Identifier.CatIrn</td>
                            </tr>
                            <tr>
                                <td>Catalogue Api Uri <sup>1</sup></td> 
                                <td>@results.Identifier.CatalogueApiUri</td>
                            </tr>

                            <tr>
                                <td>Created</td> 
                                <td>@results.Identifier.Created</td>
                            </tr>
                            <tr>
                                <td>Description</td> 
                                <td>@results.Identifier.Desc</td>
                            </tr>
                            <tr>
                                <td>EP id</td> 
                                <td>@results.Identifier.EPid</td>
                            </tr>

                            <tr>
                                    <td>Manifest Uri <sup>1</sup></td>
                                    <td>@results.Identifier.ManifestUri</td>
                            </tr>
                            <tr>
                                <td>RepositoryUri <sup>1</sup></td>
                                <td>@results.Identifier.RepositoryUri</td>
                            </tr>
                            <tr>
                                <td>Status</td> <td>@results.Identifier.Status</td>
                            </tr>
                            <tr>
                                <td>Updated</td> <td>@results.Identifier.Updated</td>
                            </tr>

                            <tbody>
                        </table>
                    </div>

                    <p>
                        1: Urls may not be valid or navigable
                    </p>
                }
                else
                {
                    <p>No identifier results</p>
                }
    
            </div>
        </div>
    </div>

}

