@page "/deposits/{id}"
@using DigitalPreservation.Common.Model
@using DigitalPreservation.Common.Model.PreservationApi
@using DigitalPreservation.Common.Model.Transit
@using DigitalPreservation.Core.Auth
@using DigitalPreservation.UI.Features
@using DigitalPreservation.UI.TagHelpers
@using DigitalPreservation.Utils
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model DepositModel

@functions {

    private bool IsLockedByOtherUser()
    {
        return Model.Deposit?.LockedBy != null && Model.Deposit.LockedBy.GetSlug() != User.GetCallerIdentity();
    }

    private bool CanBeWorkedOn()
    {
        if (IsLockedByOtherUser()) return false;
        return Model.Deposit is { Active: true } && Model.Deposit.Status != DepositStates.Exporting;
    }
}
@{
    var (jobs, jobRunning, _) = Model.PipelineJobsRunning();
    await Model.CleanupPipelineRunsForDeposit(jobs);
    ViewData["Title"] = Model.GetDisplayTitle();
    ViewData["section"] = "deposits";
    var pipelineRunStarted = jobRunning || (TempData["Valid"] != null && TempData["Valid"]!.ToString()!.ToLower().Contains("deposit locked and pipeline running"));
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 text-truncate" title="@ViewData["Title"]"><svg class="bi mb-1" style="width:1.5rem;height: 1.5rem;"><use xlink:href="#box-seam"/></svg> @ViewData["Title"]</h1>

    <div class="btn-toolbar mb-2 mb-md-0">
        @if (Model.Deposit is not null)
        {
            <button @(CanBeWorkedOn() ? "" : " disabled=disabled") type="submit" form="collapseAgDetails" class="btn btn-sm btn-outline-primary me-2">
                <svg class="bi"><use xlink:href="#floppy"/></svg><span class="ms-2">Update properties</span>
            </button>
            <form class="single-submit" method="post">


                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Actions
                    </button>
                    <ul class="dropdown-menu">
                        @if (Model.Deposit?.LockedBy != null)
                        {
                            <li>
                                <button disabled="@pipelineRunStarted" class="dropdown-item text-primary" type="submit" asp-page-handler="ReleaseLock">
                                    <svg class="bi"><use xlink:href="#unlock"/></svg><span class="ms-2">Release lock</span>
                                </button>
                            </li>
                        }
                        else
                        {
                            <li>
                                <button disabled="@pipelineRunStarted" class="dropdown-item text-primary" type="submit" asp-page-handler="Lock">
                                    <svg class="bi"><use xlink:href="#lock"/></svg><span class="ms-2">Lock deposit</span>
                                </button>
                            </li>
                        }
                        
                        <li>
                            <button disabled="@pipelineRunStarted" class="dropdown-item text-primary" type="submit" asp-page-handler="RunPipeline">
                                <svg class="bi"><use xlink:href="#gear"/></svg><span class="ms-2">Run pipeline</span>
                            </button>
                        </li>
                        <li>
                            <button disabled="@(!pipelineRunStarted)" class="dropdown-item text-primary" type="submit" asp-page-handler="ForceCompletePipelineRun">
                                <svg class="bi"><use xlink:href="#gear"/></svg><span class="ms-2">Stop pipeline run</span>
                            </button>
                        </li>
                        <li>
                            <button disabled="@pipelineRunStarted" class="dropdown-item text-primary" type="submit" asp-page-handler="ValidateStorage">
                                <svg class="bi"><use xlink:href="#database-check"/></svg><span class="ms-2">Validate storage</span>
                            </button>
                        </li>
                        <li>
                            <button disabled="@pipelineRunStarted" class="dropdown-item text-primary" type="submit" asp-page-handler="RebuildDepositFileSystem" id="rebuildMets">
                                <svg class="bi"><use xlink:href="#arrow-clockwise"/></svg><span class="ms-2">Refresh storage</span>
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item text-primary" type="button" id="toggleRhs"
                                    data-bs-toggle="collapse" data-bs-target="#sidebarInfoPanel" aria-expanded="true" aria-controls="sidebarInfoPanel">
                                <svg class="bi"><use xlink:href="#arrow-bar-right"/></svg><span class="ms-2">Toggle side panel</span>
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button @(!pipelineRunStarted ? "" : " disabled=disabled") class="dropdown-item text-primary" type="button" id="selectNonMets">
                                <svg class="bi"><use xlink:href="#check-square"/></svg><span class="ms-2">Select all non-METS</span>
                            </button>
                        </li>
                        <li>
                            <button @(!pipelineRunStarted ? "" : " disabled=disabled") class="dropdown-item text-primary" type="button" id="addSelectionToMets" data-bs-toggle="modal" data-bs-target="#addSelectionToMetsModal">
                                <svg class="bi"><use xlink:href="#bookmark-plus"/></svg><span class="ms-2">Add selected to METS</span>
                            </button>
                        </li>
                        <li>
                            <button @(!pipelineRunStarted ? "" : " disabled=disabled") class="dropdown-item text-danger" type="button" id="deleteSelection" data-bs-toggle="modal" data-bs-target="#deleteSelectionModal">
                                <svg class="bi"><use xlink:href="#check-square"/></svg><span class="ms-2">Delete selected...</span>
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-primary" role="button" target="_blank" href="@Model.GetDepositLocation()">
                                <svg class="bi"><use xlink:href="#cloud"/></svg><span class="ms-2">Open Deposit location</span>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button @(!pipelineRunStarted ? "" : " disabled=disabled") class="dropdown-item text-danger" type="button" data-bs-toggle="modal" data-bs-target="#deleteDepositModal">
                                <svg class="bi"><use xlink:href="#trash"/></svg><span class="ms-2">Delete Deposit</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </form>
        }
    </div>
</div>

<div>
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger" role="alert">
            <p>@Html.Raw(TempData["Error"])</p>
        </div>
    }
    @if (TempData["Deleted"] != null)
    {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <p>@Html.Raw(TempData["Deleted"])</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    }
    @if (TempData["Updated"] != null)
    {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <p>@Html.Raw(TempData["Updated"])</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    }
    @if (TempData["Valid"] != null)
    {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <p>@Html.Raw(TempData["Valid"])</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    }
    @if (TempData["AccessConditionsUpdated"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <p>@Html.Raw(TempData["AccessConditionsUpdated"])</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (IsLockedByOtherUser())
    {
        <div class="alert alert-danger" role="alert">
            <p>This Deposit is locked by @Model.Deposit!.LockedBy?.GetSlug()</p>
        </div>
    }
    @if (!pipelineRunStarted && TempData["MisMatchCount"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <p>@Html.Raw(TempData["MisMatchCount"]) files have metadata not present in METS.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    @if (jobRunning && TempData["Valid"] == null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <p>This deposit has a metadata pipeline being run by @Model.Deposit!.LockedBy?.GetSlug() . <br/> 
                Please refresh for status updates</p>
        </div>
    }
</div>

@if(Model.Deposit != null)
{
    <div class="container-fluid">
        <div class="row align-items-start">
            <div id="mainPanel" class="col">

                <form method="post" asp-page-handler="UpdateProperties" class="single-submit collapse show" id="collapseAgDetails">
                    <fieldset style="display: contents" @(CanBeWorkedOn() ? "" : " disabled=disabled")>

                        @if (Model.Deposit.ArchivalGroupExists)
                        {
                            <p>Archival group: <a href="/browse/@Model.Deposit.ArchivalGroup.GetPathUnderRoot()">@Model.Deposit.ArchivalGroup.GetPathUnderRoot()</a>
                            
                            <a href="#agEdit" class="ms-3 btn btn-sm btn-outline-primary" role="button" data-bs-toggle="collapse"  aria-expanded="false" aria-controls="agEdit">
                                Edit
                            </a></p>
                            <div class="form-floating mb-3 collapse" id="agEdit">
                                <input type="text" class="form-control" id="agPathUnderRoot" name="agPathUnderRoot" value="@Model.Deposit.ArchivalGroup.GetPathUnderRoot()" placeholder="(URI not set)">
                                <label for="agPathUnderRoot">Archival Group</label>
                            </div> 
                        }
                        else
                        {
                            @if (Model.ArchivalGroupTestWarning.HasText())
                            {
                                <div><small class="text-danger">@Model.ArchivalGroupTestWarning</small></div>
                            }
                            <div class="input-group mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="agPathUnderRoot" name="agPathUnderRoot" value="@Model.Deposit.ArchivalGroup.GetPathUnderRoot()" placeholder="(URI not set)">
                                    <label for="agPathUnderRoot">Archival Group</label>
                                </div>
                                <button class="btn btn-outline-secondary" type="button" id="btnAgPathHelp" data-bs-toggle="modal" data-bs-target="#archivalGroupPathModal">
                                    <svg class="bi"><use xlink:href="#question-circle"/></svg>
                                </button>
                            </div>
                        }
                        <div class="form-floating mb-3">
                            @* If this already exists, then this form element changes to read only display *@
                            <input type="text" class="form-control" id="agName" name="agName" value="@Model.Deposit.ArchivalGroupName" placeholder="(Name of Archival Group)">
                            <label for="agName">Archival Group Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="submissionText" name="submissionText" placeholder="A note for this particular deposit">@Model.Deposit.SubmissionText</textarea>
                            <label for="submissionText">Deposit Note</label>
                        </div>
                        <div class="mb-3">
                        </div>
                    </fieldset>
                </form>
                
                @if (Model.Deposit.Status != DepositStates.Exporting)
                {                
                    if (Model.RootCombinedDirectory != null)
                    {
                        <div class="table-responsive small">
                            <table class="table table-hover table-striped table-sm plain-link-table deposit-table" aria-label="table-deposit-files">
                                <thead>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col" class="dep-actions"></th>
                                    <th scope="col">Name (and path)</th>
                                    <th scope="col">Hash</th>
                                    <th scope="col">Size</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Pronom</th>
                                    <th scope="col">Virus</th>
                                </tr>
                                </thead>
                                <tbody>
                                @if (Model.WorkspaceManager.IsBagItLayout)
                                {
                                    <tr>
                                        <td colspan="8">
                                            <svg class="bi"><use xlink:href="#bag-heart"/></svg>
                                            <em>This Deposit uses BagIt layout on disk/S3.</em>
                                        </td>
                                    </tr>
                                }
                                @{
                                    var wrapper = new CombinedDirectoryRecursionWrapper(Model.RootCombinedDirectory,
                                        Model.WorkspaceManager.MetsPath!, Model.WorkspaceManager.Editable,
                                        Model.Deposit.Active, IsLockedByOtherUser(), 
                                        Model.WorkspaceManager.RootAccessRestrictions,
                                        Model.WorkspaceManager.RootRightsStatement,
                                        new Counter());
                                    @await Html.PartialAsync("_RenderCombinedDirectoryAsTableRows", wrapper)
                                }
                                </tbody>
                            </table>
                        </div>
                        <p><small>
                            @{
                                var totals = Model.RootCombinedDirectory.GetSizeTotals();
                            }
                            @totals.TotalFileCount <text> files in </text> @totals.TotalDirectoryCount <text> directories.</text><br/>
                            @StringUtils.FormatFileSize(totals.TotalSizeInDeposit, withSpace: true, fallbackIfNull: " - ") <text> in Deposit, </text>
                            @StringUtils.FormatFileSize(totals.TotalSizeInMets, withSpace: true, fallbackIfNull: " - ") <text> in METS, </text>
                            @StringUtils.FormatFileSize(totals.TotalSize, withSpace: true, fallbackIfNull: " - ") <text> Overall. </text><br/>
                            Deposit structure built @(Model.RootCombinedDirectory.DirectoryInDeposit?.Modified.GetDateDisplay() ?? " - ")
                        </small></p>
                    }
                    else
                    {
                        <p>No files have been uploaded yet.</p>
                    }
                }
                @if (Model.Deposit.Status == DepositStates.Exporting)
                {
                    <div class="alert alert-danger" role="alert">
                        <p>The server is currently exporting files into this Deposit.</p>
                    </div>
                }

                
                <hr/>
                
                
                <h3>Import Jobs</h3>

                <div class="mb-3">

                    @if (Model.Deposit.ArchivalGroup == null)
                    {
                        <p aria-label="import job message">No jobs can be run as this deposit does not have an archival group specified.</p>
                    }
                    else if (!Model.Deposit.Active)
                    {
                        <p aria-label="import job message">No jobs can be run as this deposit is no longer active.</p>
                    }
                    else if (!Model.Deposit.ArchivalGroupExists && !Model.WorkspaceManager.HasValidFiles)
                    {
                        <p aria-label="import job message">No jobs can be run as there are no valid files in the Deposit.</p>
                    }
                    else if (Model.Deposit.Status == DepositStates.Exporting)
                    {
                        <p aria-label="import job message">No jobs can be run as the Deposit status is currently 'Exporting'.</p>
                    }
                    else
                    {
                        <a class="btn btn-sm btn-primary me-2" role="button" href="/deposits/@Model.Id/importjobs/diff">
                            <svg class="bi"><use xlink:href="#file-arrow-up"/></svg><span class="ms-2">Create diff import job</span>
                        </a>
                        <a class="btn btn-sm btn-primary me-2 disabled" role="button" aria-disabled="true">
                            <svg class="bi"><use xlink:href="#file-diff"/></svg><span class="ms-2">Create custom import job</span>
                        </a>
                    }
                </div>
                    
                @{
                    var importJobResults = await Model.GetImportJobResults();
                    if (importJobResults.Count == 0)
                    {
                        <p>There are no submitted import jobs for this Deposit.</p>
                    }
                    else
                    {
                        <div class="table-responsive small">
                            <table class="table table-hover table-striped table-sm plain-link-table" aria-label="table-deposit-import-jobs">
                                <thead>
                                <tr>
                                    <th scope="col">Status</th>
                                    <th scope="col">Who</th>
                                    <th scope="col">Begun</th>
                                    <th scope="col">Finished</th>
                                    <th scope="col">From</th>
                                    <th scope="col">To</th>
                                    <th scope="col">Errors</th>
                                </tr>
                                </thead>
                                <tbody>
                                @foreach (var result in importJobResults)
                                {
                                    <tr>
                                        <td><a href="@($"/deposits/{Model.Id}/importjobs/{result.Id!.GetSlug()}")">@result.Status</a></td>
                                        <td>@result.CreatedBy?.GetSlug()?.UnEscapeFromUri()</td>
                                        <td>@result.DateBegun.GetDateDisplay()</td>
                                        <td>@result.DateFinished.GetDateDisplay()</td>
                                        <td>@result.SourceVersion</td>
                                        <td>@result.NewVersion</td>
                                        <td class="text-danger">
                                            @{
                                                if (result.Errors != null && result.Errors.Any())
                                                {
                                                    foreach (var line in result.Errors.Select(e => e.Message))
                                                    {
                                                        <p>@line</p>
                                                    }
                                                }
                                            }
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    }
                }

                <hr/>


                <h3>Pipeline Jobs</h3>

                @{
                    var pipelineJobResults = jobs;
                    if (pipelineJobResults is { Count: 0 })
                    {
                        <p>There are no submitted pipeline jobs for this Deposit.</p>
                    }
                    else
                    {
                        <div class="table-responsive small">
                            <table class="table table-hover table-striped table-sm plain-link-table" aria-label="table-deposit-import-jobs">
                                <thead>
                                <tr>
                                    <th scope="col">JobId</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Begun</th>
                                    <th scope="col">Finished</th>
                                    <th scope="col">User</th>
                                    <th scope="col">Errors</th>
                                </tr>
                                </thead>
                                <tbody>
                                @if (pipelineJobResults != null)
                        {
                            foreach (var result in pipelineJobResults)
                            {
                                <tr>
                                    <td>@result.JobId</td>
                                    <td>@result.Status</td>
                                    <td>@result.DateBegun.GetDateDisplay()</td>
                                    <td>@result.DateFinished.GetDateDisplay()</td>
                                    <td>@result.RunUser</td>
                                    <td class="text-danger">

                                        @if (result.Errors != null && result.Errors.Any())
                                        {
                                            foreach (var line in result.Errors.Select(e => e.Message))
                                            {
                                                <p>@line</p>
                                            }
                                        }

                                    </td>
                                </tr>
                            }
                        }
                        </tbody>
                            </table>
                        </div>
                    }
                }
            </div>
            
            @* START OF SIDE INFO PANEL *@
            
            <div class="collapse show col-2" id="sidebarInfoPanel">
                <dl arial-label="deposit-history">
                    <dt>Status</dt>
                    <dd aria-label="status" class="@(Model.Deposit.Status == DepositStates.Error ? "text-danger" : "")">@Model.Deposit.Status</dd>
                    <dt>Created</dt>
                    <dd aria-label="created">@Model.Deposit.Created.GetDateDisplay()</dd>
                    <dt>Created by</dt>
                    <dd aria-label="created-by"><agent-link uri="@Model.Deposit.CreatedBy"></agent-link></dd>
                    <dt>Last modified</dt>
                    <dd aria-label="last-modified">@Model.Deposit.LastModified.GetDateDisplay()</dd>
                    <dt>Last modified by</dt>
                    <dd aria-label="last-modified-by"><agent-link uri="@Model.Deposit.LastModifiedBy"></agent-link></dd>
                    <dt>Preserved</dt>
                    <dd aria-label="preserved">@Model.Deposit.Preserved.GetDateDisplay("-")</dd>
                    <dt>Preserved by</dt>
                    <dd aria-label="preserved-by"><agent-link uri="@Model.Deposit.PreservedBy"></agent-link></dd>
                    <dt>Version preserved</dt>
                    <dd aria-label="version-preserved">@(Model.Deposit.VersionPreserved ?? "-")</dd>
                    <dt>Exported</dt>
                    <dd aria-label="exported">@Model.Deposit.Exported.GetDateDisplay("-")</dd>
                    <dt>Exported by</dt>
                    <dd aria-label="exported-by"><agent-link uri="@Model.Deposit.ExportedBy"></agent-link></dd>
                    <dt>Version exported</dt>
                    <dd aria-label="version-exported">@(Model.Deposit.VersionExported ?? "-")</dd>
                </dl>
            </div>
            
            <script>
                const sideState = localStorage.getItem("sidebarInfoPanel");
                if (sideState === "hide"){
                    document.getElementById("sidebarInfoPanel").classList.remove("show");
                }
            </script>
        </div>
    </div>
    
    
}

@* ################### MODAL DIALOGUES *@

@* ------------------- UPLOAD FILE MODAL *@

<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form class="single-submit" method="post" enctype="multipart/form-data" asp-page-handler="UploadFile">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="uploadFileModalLabel"><svg class="bi"><use xlink:href="#file-earmark-arrow-up"/></svg><span class="ms-2">Upload file</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="depositFile" class="form-label">Choose a file to upload</label>
                        <input type="file" class="form-control" id="depositFile" name="depositFile" aria-describedby="fileHelp">
                        <div id="fileHelp" class="form-text">Checksum will be calculated locally and after upload.</div>
                    </div>
                    <div class="mb-3">
                        <label for="checksum" class="form-label">Checksum</label>
                        <input readonly="readonly" type="text" class="form-control" id="checksum" name="checksum">
                    </div>
                    <div class="mb-3">
                        <label for="depositFileName" class="form-label">File name</label>
                        <input type="text" class="form-control" id="depositFileName" name="depositFileName" aria-describedby="depositFileNameHelp">
                        <div id="depositFileNameHelp" class="form-text">Use this to modify the stored file name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="depositFileContentType" class="form-label">Content type</label>
                        <input type="text" class="form-control" id="depositFileContentType" name="depositFileContentType" aria-describedby="depositFileContentTypeHelp">
                        <div id="depositFileContentTypeHelp" class="form-text">(Also known as MIME type)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="newFileContext" name="newFileContext">
                    <input type="hidden" id="newFileContextIsFile" name="contextIsFile">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary"><svg class="bi"><use xlink:href="#file-earmark-arrow-up"/></svg><span class="ms-2">Upload file</span></button>
                </div>
            </form>
            
        </div>
    </div>
</div>


@* ------------------- NEW FOLDER MODAL *@

<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            
            <form class="single-submit" method="post" asp-page-handler="CreateFolder">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="newFolderModalLabel"><svg class="bi"><use xlink:href="#folder-plus"/></svg><span class="ms-2">New Folder</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newFolderName" class="form-label">New folder</label>
                        <input type="text" class="form-control" id="newFolderName" name="newFolderName" aria-describedby="newFolderNameHelp">
                        <div id="newFolderNameHelp" class="form-text">Create a new folder in the digital object</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="newFolderContext" name="newFolderContext">
                    <input type="hidden" id="newFolderContextIsFile" name="contextIsFile">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary"><svg class="bi"><use xlink:href="#folder-plus"/></svg><span class="ms-2">Create new folder</span></button>
                </div>
            </form>

        </div>
    </div>
</div>


@* ------------------- DELETE SELECTION MODAL *@

<div class="modal fade" id="deleteSelectionModal" tabindex="-1" aria-labelledby="deleteSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form class="single-submit" method="post" asp-page-handler="DeleteItems">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deleteSelectionModalLabel"><svg class="bi"><use xlink:href="#trash"/></svg><span class="ms-2">Delete selected items</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="deleteFrom" value="@Whereabouts.Deposit" id="deleteFromDeposit">
                            <label class="form-check-label" for="deleteFromDeposit">
                                Delete from Deposit only @(Model.ArchivalGroupExists ? "" : "(for updates only)")
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="deleteFrom" value="@Whereabouts.Both" id="deleteFromMetsAndDeposit">
                            <label class="form-check-label" for="deleteFromMetsAndDeposit">
                                Delete from Deposit and METS file (if present)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div id="deleteItemHelp" class="form-text">(nothing selected)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="deleteSelectionObject" name="deleteSelectionObject">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="deleteButton" disabled="disabled"><svg class="bi"><use xlink:href="#trash"/></svg><span class="ms-2">Delete</span></button>
                </div>
            </form>

        </div>
    </div>
</div>



@* ------------------- Add SELECTION TO METS MODAL *@

<div class="modal fade" id="addSelectionToMetsModal" tabindex="-1" aria-labelledby="addSelectionToMetsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form class="single-submit" method="post" asp-page-handler="AddItemsToMets">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addSelectionToMetsModalLabel"><svg class="bi"><use xlink:href="#bookmark-plus"/></svg><span class="ms-2">Add to METS file</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="addToMetsHelp" class="form-text">(nothing selected)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="addToMetsObject" name="addToMetsObject">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" id="addToMetsButton" disabled="disabled"><svg class="bi"><use xlink:href="#bookmark-plus"/></svg><span class="ms-2">Add to METS</span></button>
                </div>
            </form>

        </div>
    </div>
</div>


@* ------------------- EDIT ARCHIVAL GROUP PATH MODAL *@

<div class="modal fade" id="archivalGroupPathModal" tabindex="-1" aria-labelledby="archivalGroupPathModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="archivalGroupPathModalLabel"><svg class="bi"><use xlink:href="#question-circle"/></svg><span class="ms-2">Archival Group Path</span></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    @{
                        var agRoot = Url.PageLink("/browse", null, new { PathUnderRoot = string.Empty })!.ToLowerInvariant();
                    }
                    @if (Model.Deposit is not null && Model.Deposit.ArchivalGroupExists)
                    {
                        <p>The path is the intended URI of the Archival Group, minus the initial <code>@agRoot</code> part.</p>
                    }
                    else
                    {
                        <p>The deposit will <em>eventually</em> create an Archival Group with this path, when imported for the first time.</p>
                        <p>The path is the intended URI of the Archival Group, minus the initial <code>@agRoot</code> part.</p>
                        <p>
                            For example, if you want to create an Archival Group at
                            <code>@(agRoot)/digitised/manuscript/codex123</code>, 
                            then the value of this field should be <code>digitised/manuscript/codex123</code>.
                        </p>
                        <p>You can paste in full URLs or paths and the form will tidy them up.</p>
                        <p>This field may be set or changed later.</p>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@* ------------------- DELETE DEPOSIT MODAL *@

<div class="modal fade" id="deleteDepositModal" tabindex="-1" aria-labelledby="deleteDepositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <form class="single-submit" method="post" asp-page-handler="DeleteDeposit">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="deleteDepositModalLabel"><svg class="bi"><use xlink:href="#trash"/></svg><span class="ms-2">Delete Deposit</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="deleteDepositHelp" class="form-text">Clicking Delete below will delete this Deposit completely.</div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="confirmDepositDelete">
                            <label class="form-check-label" for="confirmDepositDelete">
                                Tick here to confirm delete
                            </label>
                            <div class="form-text">(It has no effect on an already-preserved Archival Group.)</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger" id="deleteDepositButton" disabled="disabled"><svg class="bi"><use xlink:href="#trash"/></svg><span class="ms-2">Delete Deposit</span></button>
                </div>
            </form>

        </div>
    </div>
</div>


@* ------------------- RIGHTS AND ACCESS MODAL *@

<div class="modal fade" id="accessConditionsModal" tabindex="-1" aria-labelledby="accessConditionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            
            <form class="single-submit" method="post" asp-page-handler="SetRightsAndAccess">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="accessConditionsModalLabel"><svg class="bi"><use xlink:href="#info-square"/></svg><span class="ms-2">Rights and Access</span></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label id="accessRestrictionsSelectLabel" for="accessRestrictionsSelect" class="form-label">Access Restriction(s)</label>
                        @if (CanBeWorkedOn() && Model.WorkspaceManager.Editable)
                        {
                            <select multiple id="accessRestrictionsSelect" class="form-select" name="accessRestrictions" aria-labelledby="accessRestrictionsSelectLabel">
                                @foreach (var accessRestriction in AccessRestriction.All)
                                {
                                    <!option value="@accessRestriction.Value" @(Model.WorkspaceManager.RootAccessRestrictions.Contains(accessRestriction.Value) ? " selected" : "")>@accessRestriction.Label</!option>
                                }
                            </select>
                            <div id="accessRestrictionsHelp" class="form-text">
                                Set access restriction(s) on root. <!-- TODO: when this can be done on any element in the hierarchy, display the accessConditionContext here -->
                            </div>
                        }
                        else
                        {
                            @if (Model.WorkspaceManager.RootAccessRestrictions.Count == 0)
                            {
                                <p>(No access restrictions)</p>
                            }
                            else
                            {
                                <ul>
                                    @foreach (var accessRestriction in Model.WorkspaceManager.RootAccessRestrictions)
                                    {
                                        <li>@accessRestriction</li>
                                    }
                                </ul> 
                            }
                        }
                    </div>
                    <div class="mb-3">
                        <label id="rightsStatementSelectLabel" for="rightsStatementSelect" class="form-label">Rights statement</label>
                        @if (CanBeWorkedOn() && Model.WorkspaceManager.Editable)
                        {
                            <select id="rightsStatementSelect" class="form-select" name="rightsStatement" aria-labelledby="rightsStatementSelectLabel">
                                <!option value="" @(Model.WorkspaceManager.RootRightsStatement == null ? "" : " selected")>(none)</!option>
                                @foreach (var rightsStatement in RightsStatement.All)
                                {
                                    <!option value="@rightsStatement.Value" @(Model.WorkspaceManager.RootRightsStatement == rightsStatement.Value ? " selected" : "")>@rightsStatement.Label</!option>
                                }
                            </select>
                            <div id="rightsStatementHelp" class="form-text">
                                Set rights statement on root. <!-- TODO: when this can be done on any element in the hierarchy, display the accessConditionContext here -->
                            </div>
                        }
                        else
                        {
                            <p>@(Model.WorkspaceManager.RootRightsStatement == null ? "(no rights statement)" : Model.WorkspaceManager.RootRightsStatement)</p> 
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="accessConditionContext" name="accessConditionContext">
                    <input type="hidden" id="accessConditionContextIsFile" name="accessConditionContextIsFile">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    @if (CanBeWorkedOn() && Model.WorkspaceManager.Editable)
                    {
                        <button type="submit" class="btn btn-primary"><svg class="bi"><use xlink:href="#info-square"/></svg><span class="ms-2">Save</span></button>
                    }
                </div>
            </form>

        </div>
    </div>
</div>




@* END MODALS *@


<script>
    
    const archivalGroupExists = @(Model.ArchivalGroupExists ? "true" : "false");
    const rows = document.getElementsByClassName("deposit-row");

    const newFolderContext = document.getElementById("newFolderContext");
    const newFolderContextIsFile = document.getElementById("newFolderContextIsFile");
    const newFileContext = document.getElementById("newFileContext");
    const newFileContextIsFile = document.getElementById("newFileContextIsFile");
    const accessConditionContext = document.getElementById("accessConditionContext");
    const accessConditionContextIsFile = document.getElementById("accessConditionContextIsFile");
    
    const deleteButton = document.getElementById("deleteButton");
    const deleteFromDepositRadio = document.getElementById("deleteFromDeposit");
    const deleteFromMetsAndDepositRadio = document.getElementById("deleteFromMetsAndDeposit");
    const deleteItemHelp = document.getElementById("deleteItemHelp");
    
    const deleteDepositButton = document.getElementById("deleteDepositButton");
    const confirmDepositDelete = document.getElementById("confirmDepositDelete");

    const addToMetsButton = document.getElementById("addToMetsButton");
    const addToMetsHelp = document.getElementById("addToMetsHelp");

    document.getElementById("toggleRhs").addEventListener("click", () => {
        const sideState = localStorage.getItem("sidebarInfoPanel");
        if (sideState === "hide"){
            localStorage.setItem("sidebarInfoPanel", "show");
        } else {
            localStorage.setItem("sidebarInfoPanel", "hide");
        }
    });

    document.getElementById("selectNonMets").addEventListener("click", () => {
        const itemSelectors = document.getElementsByClassName("item-selector");
        for(const itemSelector of itemSelectors)
        {
            const row = itemSelector.closest("tr");
            if (row.getAttribute("data-whereabouts") === "Deposit"){
                itemSelector.checked = true;
            }
            if (row.getAttribute("data-mismatches")?.toLowerCase() === "true"){
                itemSelector.checked = true;
            }
        }
    });

    deleteFromDepositRadio.addEventListener("change", () => {
        deleteButton.removeAttribute("disabled");
    });

    deleteFromMetsAndDepositRadio.addEventListener("change", () => {
        deleteButton.removeAttribute("disabled");
    });
    
    document.getElementById("deleteSelection").addEventListener("click", () => {

        deleteFromDepositRadio.checked = false;
        deleteFromMetsAndDepositRadio.checked = false;
        deleteButton.setAttribute("disabled", "true");
        deleteFromDepositRadio.setAttribute("disabled", "true");
        deleteFromMetsAndDepositRadio.setAttribute("disabled", "true");
        
        const itemSelectors = document.getElementsByClassName("item-selector");
        const deleteSelectionObject = { items: [] };
        let summary = "<table>";
        let metadataCount = 0;
        for(const itemSelector of itemSelectors)
        {
            if (itemSelector.checked){
                const row = itemSelector.closest("tr");
                const type = row.getAttribute("data-type");
                const relativePath = row.getAttribute("data-path");
                const isMetadata = row.getAttribute("data-metadata").toLowerCase() === "true";
                if(isMetadata){
                    metadataCount++;
                    continue;
                }
                if (relativePath && (type === "directory" || type === "file")){
                    const whereabouts = row.getAttribute("data-whereabouts");
                    const item = {
                        path: relativePath,
                        isDir: (type === "directory"),
                        where: whereabouts
                    };
                    deleteSelectionObject.items.push(item);
                    summary += "<tr><td>";
                    summary += whereabouts;
                    summary += " - </td><td>";
                    summary += item.isDir ? "🗀" : "🗎";
                    summary += "</td><td>";
                    summary += relativePath;
                    summary += "</td></tr>";
                }       
            }
        }
        summary += "</table>";
        
        if(metadataCount > 0)
        {
            deleteItemHelp.innerHTML = `<div class="alert alert-danger" role="alert"><p>${metadataCount} item(s) are in the metadata folder, these cannot be deleted.</p></div>`;
            document.getElementById("deleteSelectionObject").value = "";            
        }
        else
        {
            if (deleteSelectionObject.items.length > 0){
                deleteItemHelp.innerHTML = summary;
                deleteFromMetsAndDepositRadio.removeAttribute("disabled");
                if (archivalGroupExists){
                    deleteFromDepositRadio.removeAttribute("disabled");
                }
            } else {
                deleteItemHelp.innerHTML = "<p>There are no items selected.</p>"
            }
            document.getElementById("deleteSelectionObject").value = JSON.stringify(deleteSelectionObject);
        }
    });


    document.getElementById("addSelectionToMets").addEventListener("click", () => {

        addToMetsButton.setAttribute("disabled", "true");

        const itemSelectors = document.getElementsByClassName("item-selector");
        const addToMetsObject = [];
        let summary = "<table>";
        for(const itemSelector of itemSelectors)
        {
            if (itemSelector.checked){
                const row = itemSelector.closest("tr");
                const type = row.getAttribute("data-type");
                const relativePath = row.getAttribute("data-path");
                if (relativePath && (type === "directory" || type === "file")){
                    const whereabouts = row.getAttribute("data-whereabouts");
                    if(whereabouts === "Deposit" || whereabouts === "Both"){
                        const item = {
                            path: relativePath,
                            isDir: (type === "directory"),
                            where: whereabouts
                        };
                        addToMetsObject.push(item);
                        summary += "<tr><td>";
                        summary += item.isDir ? "🗀" : "🗎";
                        summary += " - </td><td>";
                        summary += relativePath;
                        summary += "</td></tr>";
                    }
                }
            }
        }
        summary += "</table>";
        document.getElementById("addToMetsObject").value = JSON.stringify(addToMetsObject);
        if (addToMetsObject.length > 0){
            addToMetsHelp.innerHTML = summary;
            addToMetsButton.removeAttribute("disabled");
        } else {
            addToMetsHelp.innerHTML = "<p>There are no items selected.</p>"
        }
    });
    
    
    
    document.getElementById("deleteDepositModal").addEventListener("show.bs.modal", () => {
        confirmDepositDelete.checked = false;
        deleteDepositButton.disabled = "disabled";
    });
    
    confirmDepositDelete.addEventListener("change", () => {
        if (confirmDepositDelete.checked){
            deleteDepositButton.removeAttribute("disabled");
        } else {
            deleteDepositButton.disabled = "disabled";
        }
    });
    
    let clicked = false;
    for (const row of rows) {
        const path = row.getAttribute("data-path");
        if (!(path === "objects" || path.startsWith("objects/")))
        {
            continue;
        }
        row.addEventListener('click', (event) => {
            const row = event.currentTarget;

            const path = row.getAttribute("data-path");
            const isFile = row.getAttribute("data-type") === "file";
            newFileContext.value = path;
            newFolderContext.value = path;
            accessConditionContext.value = path;
            newFolderContextIsFile.value = isFile;
            newFileContextIsFile.value = isFile;
            accessConditionContextIsFile.value = isFile;
            // deleteContext.value = path;
            // deleteContextIsFile.value = isFile;
            // deleteItemHelp.innerHTML = `You are about to delete the ${isFile ? "file" : "folder"}<br/><strong>${path}</strong>.`;
            // deleteButton.removeAttribute("disabled");
            
            if (row.classList.contains("table-active")){
                for (const r of rows) { r.classList.remove("table-active"); }
                clicked = false;
            } else {
                for (const r of rows) { r.classList.remove("table-active"); }
                row.classList.add("table-active");
                clicked = true;
            }
        });
    }


</script>

<script>
    
    // script for Upload File modal id=uploadFileModal
    
    const fileSelector = document.getElementById('depositFile');
    const checksum = document.getElementById('checksum');
    const fileName = document.getElementById('depositFileName');
    const fileContentType = document.getElementById('depositFileContentType');

    fileSelector.addEventListener('change', () => {
        hashFile();
        fileName.value = fileSelector.files[0].name;
        fileContentType.value = fileSelector.files[0].type;
    });
    
    function hashFile() {
      readBinaryFile(fileSelector.files[0])
        .then(function (result) {
          result = new Uint8Array(result);
          return window.crypto.subtle.digest("SHA-256", result);
        })
        .then(function (result) {
          result = new Uint8Array(result);
          checksum.value = Uint8ArrayToHexString(result);
        });
    }

    function readBinaryFile(file) {
      return new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = () => {
          resolve(fr.result);
        };
        fr.readAsArrayBuffer(file);
      });
    }

    function Uint8ArrayToHexString(ui8array) {
      let hexString = "",
        h;
      for (let i = 0; i < ui8array.length; i++) {
        h = ui8array[i].toString(16);
        if (h.length === 1) {
          h = "0" + h;
        }
          hexString += h;
      }
      const p = Math.pow(2, Math.ceil(Math.log2(hexString.length)));
        hexString = hexString.padStart(p, "0");
      return hexString;
    }
  
</script>

@if (TempData["Context"] != null)
{
    <script>
        const contextRow = document.querySelectorAll('[data-path="@TempData["Context"]"]');
        contextRow[0].click();
    </script>
}
