name: ECS Restart Service
description: Composite GitHub Action to pull GHCR image, retag and push to ECR and bounce ECS service

permissions:
  id-token: write  # required for OIDC / AWS
  contents: read   # This is required for actions/checkout

inputs:
  target-ecs-service:
    description: "Name of the ECS service to restart"
    required: true
  target-ecs-cluster:
    description: "Name of the ECS cluster running services"
    required: true
  wait-for-services:
    description: "If true, build will wait for ECS service to report as healthy"
    required: true
  role-arn:
    description: "AWS role arn to assume"
    required: true

runs:
  using: "composite"
  steps:
    - id: checkout
      uses: actions/checkout@v4

    - id: configure-aws-creds
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.role-arn }}
        aws-region: eu-west-1

    - id: restart-service
      shell: bash
      env:
        ECS_SERVICE: ${{ inputs.target-ecs-service }}
        ECS_CLUSTER: ${{ inputs.target-ecs-cluster }}
      run: |
        export IFS=","
        for svc in $ECS_SERVICE; do
          aws ecs update-service --force-new-deployment --cluster $ECS_CLUSTER --service $svc
        done

    - id: wait-service
      if: ${{ inputs.wait-for-services == 'true' }}
      shell: bash
      env:
        ECS_SERVICE: ${{ inputs.target-ecs-service }}
        ECS_CLUSTER: ${{ inputs.target-ecs-cluster }}
      run: |
        export IFS=","
        for svc in $ECS_SERVICE; do
          aws ecs wait services-stable --cluster $ECS_CLUSTER --service $svc
        done